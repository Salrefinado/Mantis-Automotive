{% extends "base.html" %}

{% block content %}

<div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold text-slate-800 flex items-center">
        <i class="fa-solid fa-users mr-3 text-blue-600"></i> Carteira de Clientes
    </h2>
    <button onclick="document.getElementById('modalNovoCliente').classList.remove('hidden')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg hover:scale-105 transition">
        <i class="fa-solid fa-user-plus mr-2"></i> Novo Cliente
    </button>
</div>

<div class="bg-white rounded-xl shadow-lg p-6">
    <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse align-middle">
            <thead>
                <tr class="bg-slate-100 text-slate-600 uppercase text-xs tracking-wider border-b border-slate-200">
                    <th class="p-4 rounded-tl-lg">Cliente</th>
                    <th class="p-4">Motos</th>
                    <th class="p-4 text-center">Lavagens Feitas</th>
                    <th class="p-4 text-center">Canceladas</th>
                    <th class="p-4 text-center">LTV (Gasto Total)</th>
                    <th class="p-4 w-48">Preferências</th>
                    <th class="p-4 text-center w-32">Feedback</th>
                    <th class="p-4 text-center rounded-tr-lg">Mídias</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
                {% for c in clientes %}
                <tr class="hover:bg-slate-50 transition group">
                    <td class="p-4">
                        <button onclick="abrirModalEditarCliente('{{ c.dados.id }}', '{{ c.dados.nome }}', '{{ c.dados.telefone }}', '{{ c.dados.endereco }}', '{{ c.dados.preferencias|replace('\n', ' ')|replace('\r', '') }}')" class="text-left group-hover:text-blue-600 transition">
                            <div class="font-bold text-slate-800 text-base flex items-center gap-2">
                                {{ c.dados.nome }}
                                {% if c.dados.qtd_descontos > 0 %}
                                    <span class="bg-yellow-100 text-yellow-700 text-[10px] px-2 py-0.5 rounded-full border border-yellow-200" title="{{ c.dados.qtd_descontos }} descontos disponíveis">
                                        <i class="fa-solid fa-ticket"></i> {{ c.dados.qtd_descontos }}
                                    </span>
                                {% endif %}
                                <i class="fa-solid fa-pen text-slate-300 text-xs opacity-0 group-hover:opacity-100"></i>
                            </div>
                            <div class="text-xs text-slate-400 font-mono">{{ c.dados.telefone }}</div>
                        </button>
                    </td>

                    <td class="p-4">
                        {% for m in c.motos %}
                            <div class="mb-1">
                                <span class="inline-block bg-slate-200 text-slate-700 text-xs px-2 py-1 rounded font-bold">
                                    {{ m.modelo }}
                                </span>
                                <span class="text-[10px] text-slate-400 border border-slate-200 px-1 rounded ml-1">{{ m.categoria }}</span>
                            </div>
                        {% endfor %}
                    </td>

                    <td class="p-4 text-center">
                        <span class="text-xs font-bold text-green-700 bg-green-100 px-3 py-1 rounded-full border border-green-200 shadow-sm">
                            <i class="fa-solid fa-check mr-1"></i> {{ c.qtd_lavagens }}
                        </span>
                    </td>

                    <td class="p-4 text-center">
                        {% if c.qtd_canceladas > 0 %}
                        <span class="text-xs font-bold text-red-700 bg-red-100 px-3 py-1 rounded-full border border-red-200 shadow-sm">
                            <i class="fa-solid fa-ban mr-1"></i> {{ c.qtd_canceladas }}
                        </span>
                        {% else %}
                        <span class="text-xs text-slate-300">-</span>
                        {% endif %}
                    </td>

                    <td class="p-4 text-center">
                        <span class="font-bold text-slate-700 text-sm">
                            R$ {{ "%.2f"|format(c.total_gasto) }}
                        </span>
                    </td>

                    <td class="p-4">
                        <div class="text-xs text-slate-600 italic cursor-pointer hover:bg-blue-50 p-2 rounded border border-transparent hover:border-blue-100 transition" 
                             onclick="abrirModalEditarCliente('{{ c.dados.id }}', '{{ c.dados.nome }}', '{{ c.dados.telefone }}', '{{ c.dados.endereco }}', '{{ c.dados.preferencias|replace('\n', ' ')|replace('\r', '') }}')">
                            {% if c.dados.preferencias %}
                                "{{ c.dados.preferencias[:50] }}{{ '...' if c.dados.preferencias|length > 50 else '' }}"
                            {% else %}
                                <span class="text-slate-300">Sem preferências...</span>
                            {% endif %}
                        </div>
                    </td>

                    <td class="p-4 text-center">
                        <button onclick="abrirModalFeedback('{{ c.dados.id }}', '{{ c.dados.feedback_estrelas }}', '{{ c.dados.feedback_texto|replace('\n', ' ')|replace('\r', '') }}')" 
                           class="hover:scale-110 transition duration-200">
                            <div class="text-yellow-400 text-sm mb-1">
                                {% for i in range(1, 6) %}
                                    {% if i <= c.dados.feedback_estrelas %}
                                        <i class="fa-solid fa-star"></i>
                                    {% else %}
                                        <i class="fa-regular fa-star text-slate-300"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <div class="text-[10px] text-blue-600 underline">Avaliar/Ver</div>
                        </button>
                    </td>

                    <td class="p-4 text-center">
                        <div class="flex flex-col gap-2 items-center">
                            {% if c.midias %}
                                <button onclick="document.getElementById('midia_{{ c.dados.id }}').classList.remove('hidden')" class="text-purple-600 hover:text-purple-800 font-bold text-xs bg-purple-50 hover:bg-purple-100 px-2 py-1 rounded transition border border-purple-200">
                                    <i class="fa-solid fa-images mr-1"></i> {{ c.midias|length }} Ver
                                </button>
                            {% endif %}

                            {% if c.agendamentos %}
                            <button onclick="abrirModalUploadCliente({{ c.dados.id }})" class="text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 font-bold bg-blue-50 px-2 py-1 rounded hover:bg-blue-100 border border-blue-200 transition">
                                <i class="fa-solid fa-cloud-arrow-up"></i> Upload
                            </button>
                            <select id="lista_agendamentos_{{ c.dados.id }}" class="hidden">
                                {% for a in c.agendamentos %}
                                    <option value="{{ a.id }}">
                                        {{ a.data_agendada.strftime('%d/%m') }} - {{ a.moto.modelo }} ({{ a.status }})
                                    </option>
                                {% endfor %}
                            </select>
                            {% endif %}
                        </div>

                        {% if c.midias %}
                        <div id="midia_{{ c.dados.id }}" class="fixed inset-0 bg-black bg-opacity-90 hidden z-[70] p-4 md:p-10 overflow-y-auto" onclick="if(event.target === this) this.classList.add('hidden')">
                            <div class="flex justify-between items-center mb-4 text-white">
                                <h3 class="text-xl font-bold">Galeria de {{ c.dados.nome }}</h3>
                                <button onclick="document.getElementById('midia_{{ c.dados.id }}').classList.add('hidden')" class="text-4xl hover:text-red-500">&times;</button>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                {% for m in c.midias %}
                                    <div class="bg-white p-2 rounded shadow-lg">
                                        {% if m.tipo == 'foto' %}
                                            <img src="{{ url_for('static', filename='uploads/' + m.caminho_arquivo) }}" class="w-full h-40 object-cover rounded cursor-pointer hover:opacity-90 transition" onclick="window.open(this.src, '_blank')">
                                        {% else %}
                                            <div class="bg-slate-200 h-40 flex items-center justify-center rounded text-slate-500 font-bold">
                                                <i class="fa-solid fa-video mr-2"></i> Vídeo
                                            </div>
                                            <a href="{{ url_for('static', filename='uploads/' + m.caminho_arquivo) }}" target="_blank" class="block text-center text-blue-600 text-xs mt-1 underline font-bold">Assistir Vídeo</a>
                                        {% endif %}
                                        <p class="text-[10px] text-center mt-1 text-slate-500">{{ m.data_upload.strftime('%d/%m/%Y') }}</p>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="p-8 text-center text-slate-400">Nenhum cliente cadastrado.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="modalNovoCliente" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-slate-800">Novo Cliente</h3>
                <button onclick="document.getElementById('modalNovoCliente').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            
            <form action="{{ url_for('cadastrar_cliente') }}" method="POST">
                <div class="mb-3">
                    <label class="block text-sm font-bold text-slate-700 mb-1">Dados Pessoais</label>
                    <input type="text" name="nome" placeholder="Nome Completo" class="w-full border p-2 rounded mb-2" required>
                    <input type="text" name="telefone" placeholder="WhatsApp" class="w-full border p-2 rounded mb-2" required>
                    <input type="text" name="endereco" placeholder="Endereço (Opcional)" class="w-full border p-2 rounded">
                </div>

                <div class="mb-3 border-t pt-3">
                    <label class="block text-sm font-bold text-slate-700 mb-1">Primeira Moto</label>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <input type="text" name="modelo_moto" placeholder="Modelo (Ex: Titan)" class="border p-2 rounded" required>
                        <select name="categoria_moto" class="border p-2 rounded bg-white">
                            <option value="Naked">Naked</option>
                            <option value="Sport">Sport</option>
                            <option value="Custom">Custom</option>
                            <option value="BigTrail">Big Trail</option>
                        </select>
                    </div>
                    <input type="text" name="placa_moto" placeholder="Placa" class="w-full border p-2 rounded">
                </div>

                <div class="mb-4 bg-blue-50 p-3 rounded border border-blue-100">
                    <label class="text-xs font-bold text-blue-800 uppercase block mb-1">Indicação (Quem indicou ganha desconto)</label>
                    <select name="quem_indicou_id" class="w-full border rounded p-1 select2-busca">
                        <option value="">Ninguém / Não informado</option>
                        {% for c in clientes_todos %}
                            <option value="{{ c.id }}">{{ c.nome }}</option>
                        {% endfor %}
                    </select>
                </div>

                <button type="submit" class="w-full bg-slate-900 text-white font-bold py-3 rounded-lg hover:bg-black shadow-lg">Salvar Cliente</button>
            </form>
        </div>
    </div>
</div>

<div id="modalEditarCliente" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
        <h3 class="text-lg font-bold text-slate-800 mb-4 border-b pb-2">Editar Dados do Cliente</h3>
        <form action="{{ url_for('editar_cliente_dados') }}" method="POST">
            <input type="hidden" name="cliente_id" id="edit_cliente_id">
            
            <div class="mb-3">
                <label class="block text-sm font-bold text-slate-600 mb-1">Nome</label>
                <input type="text" name="nome" id="edit_cliente_nome" class="w-full border p-2 rounded bg-slate-50" required>
            </div>
            <div class="mb-3">
                <label class="block text-sm font-bold text-slate-600 mb-1">WhatsApp</label>
                <input type="text" name="telefone" id="edit_cliente_telefone" class="w-full border p-2 rounded bg-slate-50" required>
            </div>
            <div class="mb-3">
                <label class="block text-sm font-bold text-slate-600 mb-1">Endereço</label>
                <input type="text" name="endereco" id="edit_cliente_endereco" class="w-full border p-2 rounded bg-slate-50">
            </div>
            <div class="mb-5">
                <label class="block text-sm font-bold text-blue-700 mb-1"><i class="fa-solid fa-heart mr-1"></i> Preferências do Cliente</label>
                <textarea name="preferencias" id="edit_cliente_preferencias" rows="4" class="w-full border-2 border-blue-100 p-2 rounded focus:border-blue-500 outline-none placeholder-slate-300" placeholder="Ex: Gosta de corrente bem lubrificada, cuidado com retrovisor..."></textarea>
            </div>

            <div class="flex gap-2">
                <button type="button" onclick="document.getElementById('modalEditarCliente').classList.add('hidden')" class="flex-1 bg-gray-200 py-2 rounded text-slate-700 font-bold">Cancelar</button>
                <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700 shadow">Salvar Alterações</button>
            </div>
        </form>
    </div>
</div>

<div id="modalFeedback" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden z-[60] flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 text-center">
        <h3 class="text-xl font-bold text-slate-800 mb-2">Avaliação do Serviço</h3>
        <p class="text-sm text-slate-500 mb-4">Como o cliente avaliou a experiência?</p>
        
        <form action="{{ url_for('salvar_feedback') }}" method="POST">
            <input type="hidden" name="cliente_id" id="feed_cliente_id">
            
            <div class="flex justify-center gap-2 text-3xl mb-4 text-slate-300" id="starContainer">
                <i class="fa-star fa-regular cursor-pointer hover:text-yellow-400" data-val="1" onclick="setStars(1)"></i>
                <i class="fa-star fa-regular cursor-pointer hover:text-yellow-400" data-val="2" onclick="setStars(2)"></i>
                <i class="fa-star fa-regular cursor-pointer hover:text-yellow-400" data-val="3" onclick="setStars(3)"></i>
                <i class="fa-star fa-regular cursor-pointer hover:text-yellow-400" data-val="4" onclick="setStars(4)"></i>
                <i class="fa-star fa-regular cursor-pointer hover:text-yellow-400" data-val="5" onclick="setStars(5)"></i>
            </div>
            <input type="hidden" name="feedback_estrelas" id="inputEstrelas" value="0">

            <textarea name="feedback_texto" id="feed_texto" rows="3" class="w-full border p-2 rounded mb-4 text-sm" placeholder="Comentário do cliente (Opcional)..."></textarea>

            <div class="flex gap-2">
                <button type="button" onclick="document.getElementById('modalFeedback').classList.add('hidden')" class="flex-1 bg-gray-200 py-2 rounded font-bold">Fechar</button>
                <button type="submit" class="flex-1 bg-yellow-500 text-white py-2 rounded font-bold hover:bg-yellow-600 shadow">Salvar</button>
            </div>
        </form>
    </div>
</div>

<div id="modalUploadCliente" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden z-[60] flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-slate-800">Upload de Mídia</h3>
            <button onclick="document.getElementById('modalUploadCliente').classList.add('hidden')" class="text-slate-400 hover:text-red-500">
                <i class="fa-solid fa-times text-xl"></i>
            </button>
        </div>
        
        <form id="formUploadCliente" action="" method="POST" enctype="multipart/form-data">
            <div class="mb-4">
                <label class="block text-sm font-bold text-slate-700 mb-2">Para qual serviço?</label>
                <select id="selectAgendamentoUpload" class="w-full border p-2 rounded bg-slate-50 text-sm" onchange="atualizarActionUpload()">
                    </select>
                <p class="text-[10px] text-slate-500 mt-1">Selecione o agendamento correto.</p>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-bold text-slate-700 mb-2">Arquivo</label>
                <input type="file" name="arquivo" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" required>
            </div>
            
            <div class="mb-6">
                <label class="block text-sm font-bold text-slate-700 mb-2">Tipo</label>
                <div class="flex gap-4">
                    <label class="flex items-center"><input type="radio" name="tipo" value="foto" checked class="mr-2"> Foto</label>
                    <label class="flex items-center"><input type="radio" name="tipo" value="video" class="mr-2"> Vídeo</label>
                </div>
            </div>
            
            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition">
                <i class="fa-solid fa-cloud-arrow-up mr-2"></i> Enviar Agora
            </button>
        </form>
    </div>
</div>

<script>
    function abrirModalEditarCliente(id, nome, telefone, endereco, preferencias) {
        document.getElementById('edit_cliente_id').value = id;
        document.getElementById('edit_cliente_nome').value = nome;
        document.getElementById('edit_cliente_telefone').value = telefone;
        document.getElementById('edit_cliente_endereco').value = (endereco && endereco !== 'None') ? endereco : '';
        document.getElementById('edit_cliente_preferencias').value = (preferencias && preferencias !== 'None') ? preferencias : '';
        document.getElementById('modalEditarCliente').classList.remove('hidden');
    }

    function abrirModalFeedback(id, estrelas, texto) {
        document.getElementById('feed_cliente_id').value = id;
        document.getElementById('feed_texto').value = (texto && texto !== 'None') ? texto : '';
        setStars(estrelas || 0);
        document.getElementById('modalFeedback').classList.remove('hidden');
    }
    
    // Função para abrir modal de upload preenchendo o select com os agendamentos do cliente
    function abrirModalUploadCliente(clienteId) {
        const selectOculto = document.getElementById('lista_agendamentos_' + clienteId);
        const selectModal = document.getElementById('selectAgendamentoUpload');
        
        // Limpa e copia as opções
        selectModal.innerHTML = selectOculto.innerHTML;
        
        if(selectModal.options.length > 0) {
            selectModal.selectedIndex = 0;
            atualizarActionUpload(); // Define o action inicial
            document.getElementById('modalUploadCliente').classList.remove('hidden');
        } else {
            alert('Este cliente não possui agendamentos registrados para anexar mídia.');
        }
    }
    
    function atualizarActionUpload() {
        const id = document.getElementById('selectAgendamentoUpload').value;
        const form = document.getElementById('formUploadCliente');
        form.action = "/upload_midia/" + id;
    }

    function setStars(n) {
        document.getElementById('inputEstrelas').value = n;
        const stars = document.querySelectorAll('#starContainer i');
        stars.forEach(s => {
            const val = parseInt(s.dataset.val);
            if (val <= n) {
                s.classList.remove('fa-regular', 'text-slate-300');
                s.classList.add('fa-solid', 'text-yellow-400');
            } else {
                s.classList.remove('fa-solid', 'text-yellow-400');
                s.classList.add('fa-regular', 'text-slate-300');
            }
        });
    }

    $(document).ready(function() {
        $('.select2-busca').select2({ width: '100%', placeholder: "Pesquisar..." });
    });
</script>

{% endblock %}
